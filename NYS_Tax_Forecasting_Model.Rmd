---
title: "R Notebook"
output: html_notebook
---

Ryan E. Kelly
CS 668 - Analytics Capstone
Prof Krystyn Gutu
15 OCTOBER 2024
#CODE REVIEW 1

SECTION I. Obtaining our Datasets 

(Objective section from Project Overview Statement)

Objective 1: Data Acquisition and Preparation
-	Outcome: Obtain, clean, and prepare all necessary datasets, including GDP, unemployment rates, CPI, and population movement data, for forecasting tax revenues.
-	Time Frame: Completed within the first month.
-	Measure: Datasets will be processed, cleaned, and prepared for modeling, verified by checking for missing values, formatting, and ensuring time alignment across indicators.
-	Action: Data will be sourced from the U.S. Bureau of Economic Analysis (BEA), Bureau of Labor Statistics (BLS), and U.S. Census Bureau, and pre-processed for time series forecasting.

Notes: 

For select datasets, I have registered a personal API key with the Department of Labor and Department of Commerce for data access. The only two datasets I had to import manually was for Census Data and NYS tax revenues. US Census has an API, but the requests are limited and the data was not up date. As a result, I manually pulled the data from their website and read it into R. For each dataset, I list the source URL as reference.

At this point, I am satisfied with the datasets I have pulled and will begin the next phase of satisfying the remaining objective requirements by building three time series models.

When applicable, I have converted data to conform to the New York State fiscal year. In some instances, this was not available - however - the standard 12 month average between fiscal year and calendar year line up closely. I will use calendar year in the model for the values of CPI  and population change. The remaining will be in fiscal year. 


You are welcome to use the API keys to test the data pulls. 

RK

15 October 2024




```{r}
# Packages for API access and JSON handling
library(httr)
library(jsonlite)
```

# DATASET 1 - New York State GDP (Current Dollar)
Source: US Department of Commerce - Bureau of Economic Analysis 
https://www.bea.gov/data/gdp/gdp-state

https://apps.bea.gov/iTable/?reqid=99&step=1  (REFERENCES FOR TABLE CODES)
Table code: CAGDP2
NY State Code: 36000

```{r}
# Set up BEA API key and URL for GDP data (Current-Dollar GDP for NYS)
bea_api_key <- "D4DCEE44-9DAF-4560-9E02-3F1DE64F5165"

# API Request Format
bea_api_url <- paste0("https://apps.bea.gov/api/data/?&UserID=", bea_api_key, 
                      "&method=GetData&datasetname=Regional&TableName=CAGDP2&GeoFips=36000&LineCode=1&Year=ALL&ResultFormat=JSON")

# API Call
gdp_response <- GET(bea_api_url)

if (status_code(gdp_response) == 200) {
  message("API request successful.")
  # Parse Data
  gdp_content <- content(gdp_response, as = "text")
  ny_gdp_data <- fromJSON(gdp_content)$BEAAPI$Results$Data
} else {
  stop("API request failed. Status code: ", status_code(gdp_response))
}
```
```{r}
head(ny_gdp_data)
str(ny_gdp_data)
summary(ny_gdp_data)
```



```{r}
ny_gdp_df <- as.data.frame(ny_gdp_data)
colnames(ny_gdp_df) <- c("series_id", "geofips", "region", "year", "units", "industry", "GDP_value")

# Adjust GDP values for real dollars
ny_gdp_df$GDP_value <- as.numeric(ny_gdp_df$GDP_value) * 1000
ny_gdp_df$year <- as.numeric(ny_gdp_df$year)

ny_gdp_df$fiscal_year <- paste(ny_gdp_df$year - 1, ny_gdp_df$year, sep = "-")
```


```{r}
View(ny_gdp_df)

```


```{r}
windowsFonts(A = windowsFont("Times New Roman"))
par(family = "A", mar = c(5, 5, 4, 2) + 0.1)

year_range <- paste(min(ny_gdp_df$year), max(ny_gdp_df$year), sep = " - ")

plot(
  ny_gdp_df$year, ny_gdp_df$GDP_value / 1e12,
  type = "b",
  col = "black",
  xlab = "Year",
  ylab = "GDP Value (Trillions of Dollars)",
  main = paste("New York State GDP CY (", year_range, ")", sep = ""),
  pch = 19,
  lwd = 1,
  las = 1,
  cex.axis = 0.8,
  cex.lab = 1
)

grid(nx = NULL, ny = NULL, col = "gray", lty = "dotted")


```

# DATASET 2 -  New York State Unemployment Data
Source: US Department of Labor - Bureau of Labor Statistics
https://data.bls.gov/pdq/SurveyOutputServlet


```{r}
# Set up BLS API key and series ID for New York State unemployment
bls_api_key <- "85f2b89f6fd64218a8ef61270b0e8dc1"
ny_unemployment_series_id <- "LAUST360000000000003"

# API Request Format
bls_api_url <- paste0("https://api.bls.gov/publicAPI/v2/timeseries/data/", 
                      ny_unemployment_series_id, 
                      "?registrationkey=", bls_api_key, 
                      "&startyear=2010&endyear=2023")

# API Call
unemployment_response <- GET(bls_api_url)

if (status_code(unemployment_response) == 200) {
  message("API request successful.")
  # Parse data
  unemployment_content <- content(unemployment_response, as = "parsed", type = "application/json")
  ny_unemployment_data <- Filter(function(x) !is.null(x$year) && 
                                              !is.null(x$period) && 
                                              !is.null(x$periodName) && 
                                              !is.null(x$value), 
                                 unemployment_content$Results$series[[1]]$data)
} else {
  stop("API request failed. Status code: ", status_code(unemployment_response))
}

```

```{r}
head(ny_unemployment_data)
View(ny_unemployment_data)

```

```{r}
# Convert to a dataframe and assign numeric types
ny_unemployment_df <- data.frame(
  year = as.numeric(unlist(lapply(ny_unemployment_data, function(x) x$year))),
  period = unlist(lapply(ny_unemployment_data, function(x) x$period)),
  period_name = unlist(lapply(ny_unemployment_data, function(x) x$periodName)),
  unemployment_rate = as.numeric(unlist(lapply(ny_unemployment_data, function(x) x$value)))
)
```


```{r}
# Remove "M13" summary data and calculate fiscal year
ny_unemployment_df <- subset(ny_unemployment_df, period != "M13")
ny_unemployment_df$fiscal_year <- ifelse(ny_unemployment_df$period %in% paste0("M", sprintf("%02d", 1:3)), 
                                         ny_unemployment_df$year - 1, ny_unemployment_df$year)

# Calculate averages for calendar and fiscal years
ny_annual_unemployment <- aggregate(unemployment_rate ~ year, data = ny_unemployment_df, FUN = mean)
colnames(ny_annual_unemployment)[2] <- "unemployment_CY"

ny_fiscal_unemployment <- aggregate(unemployment_rate ~ fiscal_year, data = ny_unemployment_df, FUN = mean)
colnames(ny_fiscal_unemployment)[2] <- "unemployment_FY"

# Combine calendar and fiscal year data into one dataframe
ny_unemployment <- merge(ny_annual_unemployment, ny_fiscal_unemployment, 
                         by.x = "year", by.y = "fiscal_year", all = TRUE)


```

```{r}
View(ny_unemployment)
```


```{r}
windowsFonts(A = windowsFont("Times New Roman"))
par(family = "A", mar = c(5, 5, 4, 2) + 0.1)

plot(
  ny_unemployment$year,
  ny_unemployment$unemployment_CY,
  type = "o",
  col = "black",
  lwd = 1,
  pch = 19,
  xaxt = "n",
  yaxt = "n",
  ylab = "Average Unemployment Rate (%)",
  xlab = "Year",
  main = "New York State Average Unemployment Rate CY (2010 - 2023)"
)

axis(1, at = ny_unemployment$year, labels = ny_unemployment$year, las = 2)
axis(2, las = 1)

grid(nx = length(ny_unemployment$year), ny = NULL, col = "lightgray", lty = "dotted")

```


```{r}
windowsFonts(A = windowsFont("Times New Roman"))
par(family = "A", mar = c(5, 5, 4, 2) + 0.1)

plot(
  ny_unemployment$year,
  ny_unemployment$unemployment_FY,
  type = "o",
  col = "black",
  lwd = 1,
  pch = 19,
  xaxt = "n",
  yaxt = "n",
  ylab = "Average Unemployment Rate (%)",
  xlab = "Fiscal Year",
  main = "New York State Average Unemployment Rate FY (2010 - 2023)"
)

axis(1, at = ny_unemployment$year, labels = ny_unemployment$year, las = 2)
axis(2, las = 1)

grid(nx = length(ny_unemployment$year), ny = NULL, col = "lightgray", lty = "dotted")

```


DATASET #3 - CPI Data - North Eastern US
Source: US Department of Labor - Bureau of Labor Statistics
https://www.bls.gov/regions/mid-atlantic/news-release/consumerpriceindex_northeast.htm

https://data.bls.gov/timeseries/CUUR0100SA0?amp%253bdata_tool=XGtable&output_view=data&include_graphs=true

```{r}
# Set up BLS API key and series ID for Northeast region CPI (All Items, Urban Consumers)
bls_api_key <- "85f2b89f6fd64218a8ef61270b0e8dc1"
cpi_series_id <- "CUUR0100SA0"

# API Request Format
cpi_api_url <- paste0("https://api.bls.gov/publicAPI/v2/timeseries/data/", 
                      cpi_series_id, 
                      "?registrationkey=", bls_api_key, 
                      "&startyear=2010&endyear=2023")

# API Call
cpi_response <- GET(cpi_api_url)

if (status_code(cpi_response) == 200) {
  message("API request successful.")
  # Parse and filter the data
  cpi_content <- content(cpi_response, as = "parsed", type = "application/json")
  northeast_cpi_data <- Filter(function(x) !is.null(x$year) && !is.null(x$period) && 
                                            !is.null(x$periodName) && !is.null(x$value), 
                               cpi_content$Results$series[[1]]$data)
} else {
  stop("API request failed. Status code: ", status_code(cpi_response))
}

```
```{r}
head(northeast_cpi_data)
summary(northeast_cpi_data)
View(northeast_cpi_data)
```


```{r}
northeast_cpi_df <- data.frame(
  year = as.numeric(unlist(lapply(northeast_cpi_data, function(x) x$year))),
  period = unlist(lapply(northeast_cpi_data, function(x) x$period)),
  period_name = unlist(lapply(northeast_cpi_data, function(x) x$periodName)),
  cpi_index = as.numeric(unlist(lapply(northeast_cpi_data, function(x) x$value)))
)

```


```{r}
# Aggregate for Calendar Year
calendar_year_cpi <- aggregate(cpi_index ~ year, data = northeast_cpi_df, FUN = mean)

# Aggregate for Fiscal Year (April 1 - March 31)
fiscal_year_cpi <- aggregate(cpi_index ~ year, 
                             data = subset(northeast_cpi_df, period_name %in% c("April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March")), 
                             FUN = function(x) mean(x, na.rm = TRUE))

# Adjust fiscal year labels to start in previous year 
fiscal_year_cpi$year <- fiscal_year_cpi$year - 1

# Merge Calendar Year and Fiscal Year data into a single dataframe
ne_cpi_data <- merge(calendar_year_cpi, fiscal_year_cpi, by = "year", all = TRUE)
colnames(ne_cpi_data) <- c("year", "cpi_calendar_year", "cpi_fiscal_year")

```


```{r}

head(ne_cpi_data)
summary(ne_cpi_data)
View(ne_cpi_data)

```


```{r}

windowsFonts(A = windowsFont("Times New Roman"))
par(family = "A", mar = c(5, 5, 4, 2) + 0.1)
cpi_range <- range(ne_cpi_data$cpi_calendar_year, na.rm = TRUE)
ylim_upper <- cpi_range[2] + 10

plot(
  ne_cpi_data$year, ne_cpi_data$cpi_calendar_year, type = "o",
  col = "black", pch = 19, lty = 1, lwd = 1,
  xlab = "Year", ylab = "CPI Index (Calendar Year)",
  main = "Northeast Consumer Price Index (CPI) - CY(2010-2023)",
  ylim = c(cpi_range[1], ylim_upper)
)

grid(nx = NULL, ny = NULL, col = "gray", lty = "dotted")


```
```{r}

windowsFonts(A = windowsFont("Times New Roman"))
par(family = "A", mar = c(5, 5, 4, 2) + 0.1)

cpi_range_fy <- range(ne_cpi_data$cpi_fiscal_year, na.rm = TRUE)
ylim_upper_fy <- cpi_range_fy[2] + 10

plot(
  ne_cpi_data$year, ne_cpi_data$cpi_fiscal_year, type = "o",
  col = "black", pch = 19, lty = 1, lwd = 1,
  xlab = "Fiscal Year", ylab = "CPI Index (Fiscal Year)",
  main = "Northeast Consumer Price Index (CPI) - FY(2010-2022)",
  ylim = c(cpi_range_fy[1], ylim_upper_fy)
)

grid(nx = NULL, ny = NULL, col = "gray", lty = "dotted")

```

#DATASET 4  - Census Data - New York State Population Movement 
https://www.census.gov/data/datasets/time-series/demo/popest/2020s-state-total.html
Manual Entry


```{r}
file_path <- "C:/Users/Ryane/Proton Drive/R Project Files/NY-NST-EST2023-POPCHG2020_2023.csv"
ny_pop_data <- read.csv(file_path)
head(ny_pop_data)

```
```{r}
summary(ny_pop_data)
```


```{r}
ny_pop_data$POPESTIMATE2020 <- as.numeric(ny_pop_data$POPESTIMATE2020)
ny_pop_data$POPESTIMATE2021 <- as.numeric(ny_pop_data$POPESTIMATE2021)
ny_pop_data$POPESTIMATE2022 <- as.numeric(ny_pop_data$POPESTIMATE2022)
ny_pop_data$POPESTIMATE2023 <- as.numeric(ny_pop_data$POPESTIMATE2023)

ny_pop_data$PPOPCHG_2020 <- as.numeric(ny_pop_data$PPOPCHG_2020)
ny_pop_data$PPOPCHG_2021 <- as.numeric(ny_pop_data$PPOPCHG_2021)
ny_pop_data$PPOPCHG_2022 <- as.numeric(ny_pop_data$PPOPCHG_2022)
ny_pop_data$PPOPCHG_2023 <- as.numeric(ny_pop_data$PPOPCHG_2023)

```


```{r}
windowsFonts(A = windowsFont("Times New Roman"))
par(family = "A", las = 1) 

years <- c(2020, 2021, 2022, 2023)
pop_estimates_scaled <- c(ny_pop_data$POPESTIMATE2020, ny_pop_data$POPESTIMATE2021, ny_pop_data$POPESTIMATE2022, ny_pop_data$POPESTIMATE2023) / 1e6

plot(years, pop_estimates_scaled, type = "o", col = "black", xlab = "Year", ylab = "Population Estimate (Millions)",
     main = "Population Estimates for New York (2020-2023)", pch = 16, lty = 1, cex.axis = 1.1, cex.lab = 1.2, 
     xaxt = "n")

axis(1, at = years, labels = years)
grid(nx = NULL, ny = NULL, lty = 2, col = "gray")


```

```{r}

windowsFonts(A = windowsFont("Times New Roman"))
par(family = "A", las = 1)

pop_change <- c(ny_pop_data$PPOPCHG_2020, ny_pop_data$PPOPCHG_2021, ny_pop_data$PPOPCHG_2022, ny_pop_data$PPOPCHG_2023)

# reverse bar chart - for flavor
barplot(pop_change, names.arg = years, col = "lightblue", xlab = "Year", 
        ylab = "Population Change (%)", main = "New York Population Change CY(2020-2023)", 
        cex.axis = 1.1, cex.lab = 1.2)

grid(nx = NA, ny = NULL, lty = 2, col = "gray")



```
# DATASET 5 - New York State Tax Projections
Source: New York State Department of Finance
Manual Entry
https://www.tax.ny.gov/research/stats/statistics/stat_fy_collections.htm
```{r}
library(readr)


file_path <- "C:/Users/Ryane/Proton Drive/R Project Files/NYS_tax_revenues_2015-2023.csv"
ny_tax_data <- read.csv(file_path)

colnames(ny_tax_data) <- c(
  "fiscal_year",
  "total_collection",
  "personal_income",
  "corporation_business",
  "sales_excise_user",
  "property_transfers",
  "other_taxes_fees"
)

```

```{r}

ny_tax_data$total_collection <- as.numeric(gsub("[^0-9.]", "", ny_tax_data$total_collection))
ny_tax_data$personal_income <- as.numeric(gsub("[^0-9.]", "", ny_tax_data$personal_income))
ny_tax_data$corporation_business <- as.numeric(gsub("[^0-9.]", "", ny_tax_data$corporation_business))
ny_tax_data$sales_excise_user <- as.numeric(gsub("[^0-9.]", "", ny_tax_data$sales_excise_user))
ny_tax_data$property_transfers <- as.numeric(gsub("[^0-9.]", "", ny_tax_data$property_transfers))
ny_tax_data$other_taxes_fees <- as.numeric(gsub("[^0-9.]", "", ny_tax_data$other_taxes_fees))
```

```{r}
str(ny_tax_data)
summary(ny_tax_data)
View(ny_tax_data)
```

```{r}
windowsFonts(A = windowsFont("Times New Roman"))
par(family = "A")

barplot(
  ny_tax_data$total_collection / 1e9,
  names.arg = ny_tax_data$fiscal_year,
  col = "lightblue",
  xlab = "Fiscal Year",
  ylab = "Total State Collections (in billions USD)",
  main = "New York State Total Tax Revenues by FY(2015-2023)",
  las = 1,
  ylim = c(0, max(ny_tax_data$total_collection / 1e9) * 1.1)
)


grid(nx = NA, ny = NULL, col = "gray")
abline(h = seq(20, max(ny_tax_data$total_collection / 1e9), by = 20), col = "gray", lty = "dotted")

box() 

```

##################### STEP 2 - MODEL BUILDING ##########################



```{r}
ny_gdp_df
ny_unemployment
ne_cpi_data
ny_tax_data

ny_pop_data$POPESTIMATE2020 <- as.numeric(ny_pop_data$POPESTIMATE2020)
ny_pop_data$POPESTIMATE2021 <- as.numeric(ny_pop_data$POPESTIMATE2021)
ny_pop_data$POPESTIMATE2022 <- as.numeric(ny_pop_data$POPESTIMATE2022)
ny_pop_data$POPESTIMATE2023 <- as.numeric(ny_pop_data$POPESTIMATE2023)

ny_pop_data$PPOPCHG_2020 <- as.numeric(ny_pop_data$PPOPCHG_2020)
ny_pop_data$PPOPCHG_2021 <- as.numeric(ny_pop_data$PPOPCHG_2021)
ny_pop_data$PPOPCHG_2022 <- as.numeric(ny_pop_data$PPOPCHG_2022)
ny_pop_data$PPOPCHG_2023 <- as.numeric(ny_pop_data$PPOPCHG_2023)
```





